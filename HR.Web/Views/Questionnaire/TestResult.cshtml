@model HR.Web.Controllers.QuestionnaireTestResult
@{
    ViewBag.Title = "Test Results - " + Model.Position.Title;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>üìä Test Results</h2>
            <p class="text-muted mb-0">
                Position: <strong>@Model.Position.Title</strong> | 
                Completed: @Model.CompletedAt.ToString("MMM dd, yyyy HH:mm")
            </p>
        </div>
        <div>
            <a href="@Url.Action("Test", "Questionnaire", new { positionId = Model.Position.Id })" class="btn btn-primary">
                üîÑ Retest
            </a>
            <a href="@Url.Action("Preview", "Questionnaire", new { positionId = Model.Position.Id })" class="btn btn-outline-secondary ml-2">
                üëÅÔ∏è Preview
            </a>
        </div>
    </div>

    <!-- Score Summary -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Overall Score</h5>
        </div>
        <div class="card-body text-center">
            <div class="row">
                <div class="col-md-4">
                    <h1 class="@(Model.Percentage >= 80 ? "text-success" : Model.Percentage >= 60 ? "text-warning" : "text-danger")">
                        @Model.TotalScore/@Model.MaxScore
                    </h1>
                    <p class="text-muted">Points Scored</p>
                </div>
                <div class="col-md-4">
                    <h1 class="@(Model.Percentage >= 80 ? "text-success" : Model.Percentage >= 60 ? "text-warning" : "text-danger")">
                        @Model.Percentage.ToString("F1")%
                    </h1>
                    <p class="text-muted">Percentage</p>
                </div>
                <div class="col-md-4">
                    <h1 class="@(Model.Percentage >= 80 ? "text-success" : Model.Percentage >= 60 ? "text-warning" : "text-danger")">
                        @GetGrade(Model.Percentage)
                    </h1>
                    <p class="text-muted">Grade</p>
                </div>
            </div>
            
            <div class="progress mt-4" style="height: 25px;">
                <div class="progress-bar @(Model.Percentage >= 80 ? "bg-success" : Model.Percentage >= 60 ? "bg-warning" : "bg-danger")" 
                     role="progressbar" 
                     style="width: @Model.Percentage%">
                    @Model.Percentage.ToString("F1)%" Complete
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Analysis -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Performance Analysis</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6>Score Distribution</h6>
                    <canvas id="scoreChart" width="400" height="200"></canvas>
                </div>
                <div class="col-md-6">
                    <h6>Performance Insights</h6>
                    @GetPerformanceInsights(Model.Percentage)
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Results -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Detailed Question Results</h5>
        </div>
        <div class="card-body">
            @for (int i = 0; i < Model.QuestionResults.Count; i++)
            {
                var result = Model.QuestionResults[i];
                var performanceClass = result.Percentage >= 80 ? "success" : 
                                       result.Percentage >= 60 ? "warning" : "danger";
                
                <div class="question-result-item mb-3 p-3 border rounded">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="flex-grow-1">
                            <span class="badge badge-primary mr-2">@(i + 1)</span>
                            <h6 class="d-inline">@result.QuestionText</h6>
                        </div>
                        <div class="text-right">
                            <span class="badge badge-@performanceClass">
                                @result.Score/@result.MaxScore pts
                            </span>
                            <div class="small text-muted">@result.Percentage.ToString("F1")%</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="answer-section">
                                <strong>Your Answer:</strong>
                                <div class="answer-text mt-1 p-2 bg-light rounded">
                                    @if (string.IsNullOrWhiteSpace(result.Answer))
                                    {
                                        <em class="text-muted">No answer provided</em>
                                    }
                                    else
                                    {
                                        @result.Answer
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="score-visualization">
                                <small class="text-muted">Score Breakdown:</small>
                                <div class="progress mt-1" style="height: 15px;">
                                    <div class="progress-bar bg-@performanceClass" 
                                         role="progressbar" 
                                         style="width: @result.Percentage%">
                                    </div>
                                </div>
                                <div class="mt-2">
                                    @if (result.Percentage >= 80)
                                    {
                                        <span class="text-success">‚úÖ Excellent</span>
                                    }
                                    else if (result.Percentage >= 60)
                                    {
                                        <span class="text-warning">‚ö†Ô∏è Good</span>
                                    }
                                    else
                                    {
                                        <span class="text-danger">‚ùå Needs Improvement</span>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Recommendations -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0">Recommendations</h5>
        </div>
        <div class="card-body">
            @GetRecommendations(Model.QuestionResults)
        </div>
    </div>

    <div class="mt-4 text-center">
        <button onclick="window.print()" class="btn btn-outline-primary">
            üñ®Ô∏è Print Results
        </button>
        <a href="@Url.Action("Builder", "Questionnaire", new { positionId = Model.Position.Id })" class="btn btn-outline-secondary ml-2">
            ‚öôÔ∏è Improve Questionnaire
        </a>
    </div>
</div>

@functions {
    private string GetGrade(decimal percentage)
    {
        if (percentage >= 90) return "A+";
        if (percentage >= 85) return "A";
        if (percentage >= 80) return "A-";
        if (percentage >= 75) return "B+";
        if (percentage >= 70) return "B";
        if (percentage >= 65) return "B-";
        if (percentage >= 60) return "C+";
        if (percentage >= 55) return "C";
        if (percentage >= 50) return "C-";
        return "D";
    }

    private HtmlString GetPerformanceInsights(decimal percentage)
    {
        var insights = new List<string>();
        
        if (percentage >= 80)
        {
            insights.Add("üéâ <strong>Excellent Performance!</strong> You demonstrated strong understanding of the requirements.");
            insights.Add("‚ú® Your answers show depth and clarity in addressing the key competencies.");
        }
        else if (percentage >= 60)
        {
            insights.Add("üëç <strong>Good Performance!</strong> You have a solid foundation with room for improvement.");
            insights.Add("üìà Consider providing more specific examples in your responses.");
        }
        else
        {
            insights.Add("üìö <strong>Room for Growth!</strong> Focus on developing key competencies.");
            insights.Add("üéØ Practice articulating your experience more clearly and with specific examples.");
        }
        
        return new HtmlString(string.Join("<br/>", insights));
    }

    private HtmlString GetRecommendations(List<TestQuestionResult> results)
    {
        var recommendations = new List<string>();
        
        var lowScoreQuestions = results.Where(r => r.Percentage < 60).ToList();
        var unansweredQuestions = results.Where(r => string.IsNullOrWhiteSpace(r.Answer)).ToList();
        
        if (unansweredQuestions.Any())
        {
            recommendations.Add($"<div class='alert alert-warning'><strong>‚ö†Ô∏è Unanswered Questions:</strong> {unansweredQuestions.Count} question(s) were left blank. Always attempt to answer every question.</div>");
        }
        
        if (lowScoreQuestions.Any())
        {
            recommendations.Add($"<div class='alert alert-info'><strong>üí° Areas for Improvement:</strong> Focus on these question types:");
            recommendations.Add("<ul>");
            foreach (var question in lowScoreQuestions.Take(3))
            {
                recommendations.Add($"<li>{question.QuestionText.Substring(0, Math.Min(50, question.QuestionText.Length))}...</li>");
            }
            recommendations.Add("</ul></div>");
        }
        
        var avgScore = results.Average(r => r.Percentage);
        if (avgScore >= 70)
        {
            recommendations.Add("<div class='alert alert-success'><strong>üåü Great Job!</strong> You're ready to move forward with confidence.</div>");
        }
        
        return new HtmlString(string.Join("", recommendations));
    }
}

<style>
.question-result-item {
    background-color: #f8f9fa;
    transition: all 0.2s ease;
}

.question-result-item:hover {
    background-color: #e9ecef;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.answer-text {
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
    max-height: 100px;
    overflow-y: auto;
}

.score-visualization {
    border-left: 3px solid #e9ecef;
    padding-left: 15px;
}

.progress {
    background-color: #e9ecef;
}

.badge {
    font-size: 0.8em;
}

@media print {
    .btn, .d-flex.justify-content-between {
        display: none !important;
    }
    
    .card {
        page-break-inside: avoid;
    }
}
</style>

@section Scripts {
<script>
$(document().ready(function() {
    // Simple chart visualization
    var canvas = document.getElementById('scoreChart');
    if (canvas && canvas.getContext) {
        var ctx = canvas.getContext('2d');
        var scores = @Html.Raw(Json.Encode(Model.QuestionResults.Select(r => r.Percentage)));
        var labels = @Html.Raw(Json.Encode(Model.QuestionResults.Select((r, i) => "Q" + (i + 1))));
        
        // Simple bar chart
        var barWidth = 40;
        var spacing = 10;
        var chartHeight = 150;
        var chartWidth = scores.length * (barWidth + spacing);
        
        canvas.width = chartWidth;
        canvas.height = chartHeight;
        
        var maxScore = Math.max(...scores, 100);
        
        scores.forEach(function(score, index) {
            var barHeight = (score / maxScore) * (chartHeight - 20);
            var x = index * (barWidth + spacing) + spacing;
            var y = chartHeight - barHeight - 10;
            
            // Draw bar
            ctx.fillStyle = score >= 80 ? '#28a745' : score >= 60 ? '#ffc107' : '#dc3545';
            ctx.fillRect(x, y, barWidth, barHeight);
            
            // Draw label
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(labels[index], x + barWidth/2, chartHeight - 2);
            ctx.fillText(score.toFixed(1) + '%', x + barWidth/2, y - 5);
        });
    }
    
    // Animate score display
    $('.progress-bar').each(function() {
        var progressBar = $(this);
        var width = progressBar.css('width');
        progressBar.css('width', '0%');
        setTimeout(function() {
            progressBar.css('width', width);
        }, 100);
    });
});
</script>
}
