@model HR.Web.Controllers.QuestionnaireTestViewModel
@{
    ViewBag.Title = "Test Questionnaire - " + Model.Position.Title;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>üß™ Test Questionnaire</h2>
            <p class="text-muted mb-0">
                Position: <strong>@Model.Position.Title</strong> | 
                Department: @Model.Position.Department?.Name
            </p>
        </div>
        <div>
            <a href="@Url.Action("Preview", "Questionnaire", new { positionId = Model.Position.Id })" class="btn btn-outline-secondary">
                üëÅÔ∏è Preview
            </a>
            <a href="@Url.Action("Builder", "Questionnaire", new { positionId = Model.Position.Id })" class="btn btn-outline-primary ml-2">
                ‚öôÔ∏è Edit
            </a>
        </div>
    </div>

    <div class="alert alert-info">
        <strong>Test Mode:</strong> This is a test version of the questionnaire. Your answers will be scored to help you evaluate the question effectiveness.
    </div>

    @using (Html.BeginForm("SubmitTest", "Questionnaire", FormMethod.Post))
    {
        @Html.AntiForgeryToken()
        @Html.HiddenFor(m => m.Position.Id)
        
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Questionnaire (@Model.Questions.Count questions)</h5>
            </div>
            <div class="card-body">
                @for (int i = 0; i < Model.Questions.Count; i++)
                {
                    var question = Model.Questions[i];
                    <div class="question-test-item mb-4 p-3 border rounded">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <span class="badge badge-primary mr-2">@(i + 1)</span>
                                <span class="badge badge-info mr-2">@question.QuestionType</span>
                                @if (question.IsRequired)
                                {
                                    <span class="badge badge-warning">Required</span>
                                }
                            </div>
                            <small class="text-muted">Max Points: @question.Options.Max(o => o.Points)</small>
                        </div>
                        
                        <h6 class="mb-3">@question.QuestionText</h6>
                        
                        @Html.HiddenFor(m => m.Questions[i].QuestionId)
                        @Html.HiddenFor(m => m.Questions[i].QuestionText)
                        @Html.HiddenFor(m => m.Questions[i].QuestionType)
                        @Html.HiddenFor(m => m.Questions[i].Order)
                        @Html.HiddenFor(m => m.Questions[i].IsRequired)
                        
                        @if (question.QuestionType == "Choice")
                        {
                            <div class="choice-options">
                                @foreach (var option in question.Options)
                                {
                                    <div class="form-check mb-2">
                                        <label class="form-check-label">
                                            @Html.RadioButtonFor(m => m.Questions[i].Answer, option.Text, new { @class = "form-check-input" })
                                            @option.Text
                                            <span class="ml-2 badge badge-light">@option.Points pts</span>
                                        </label>
                                    </div>
                                }
                            </div>
                        }
                        else if (question.QuestionType == "Rating")
                        {
                            <div class="rating-options">
                                <div class="d-flex align-items-center">
                                    <span class="mr-3">Rate your answer:</span>
                                    @for (int r = 1; r <= 5; r++)
                                    {
                                        <label class="rating-star mr-1">
                                            @Html.RadioButtonFor(m => m.Questions[i].Answer, r.ToString(), new { @class = "rating-input" })
                                            <span class="star">‚òÖ</span>
                                        </label>
                                    }
                                </div>
                                <small class="text-muted">1 = Poor, 5 = Excellent</small>
                            </div>
                        }
                        else if (question.QuestionType == "Number")
                        {
                            <div class="number-input">
                                @Html.TextBoxFor(m => m.Questions[i].Answer, new { 
                                    @class = "form-control", 
                                    type = "number", 
                                    placeholder = "Enter a number...",
                                    step = "any"
                                })
                            </div>
                        }
                        else if (question.QuestionType == "Text")
                        {
                            <div class="text-input">
                                @Html.TextAreaFor(m => m.Questions[i].Answer, new { 
                                    @class = "form-control", 
                                    rows = 4, 
                                    placeholder = "Enter your answer here..."
                                })
                            </div>
                        }
                        
                        @if (question.IsRequired)
                        {
                            <div class="required-indicator mt-2">
                                <small class="text-danger">* This question is required</small>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>

        <div class="mt-4">
            <button type="submit" class="btn btn-success btn-lg">
                üìä Submit & See Score
            </button>
            <a href="@Url.Action("Preview", "Questionnaire", new { positionId = Model.Position.Id })" class="btn btn-link">
                Cancel
            </a>
        </div>
    }
</div>

<style>
.question-test-item {
    background-color: #f8f9fa;
    transition: all 0.2s ease;
}

.question-test-item:hover {
    background-color: #e9ecef;
}

.rating-options {
    display: flex;
    flex-direction: column;
}

.rating-star {
    cursor: pointer;
    font-size: 1.5em;
    color: #ddd;
    transition: color 0.2s ease;
}

.rating-star:hover .star,
.rating-star input:checked + .star {
    color: #ffc107;
}

.rating-input {
    display: none;
}

.choice-options .form-check-label {
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 4px;
    transition: background-color 0.2s ease;
}

.choice-options .form-check-label:hover {
    background-color: #e9ecef;
}

.form-check-input:checked + .form-check-label {
    background-color: #e3f2fd;
    font-weight: 500;
}

.text-input textarea,
.number-input input {
    border: 2px solid #e9ecef;
    transition: border-color 0.2s ease;
}

.text-input textarea:focus,
.number-input input:focus {
    border-color: #007bff;
}

.required-indicator {
    opacity: 0;
    transition: opacity 0.2s ease;
}

.question-test-item:hover .required-indicator {
    opacity: 1;
}
</style>

@section Scripts {
<script>
$(document().ready(function() {
    // Form validation
    $('form').submit(function(e) {
        var isValid = true;
        var firstInvalid = null;
        
        $('.question-test-item').each(function() {
            var questionItem = $(this);
            var isRequired = questionItem.find('input[name$="IsRequired"]').val() === 'True';
            var answer = '';
            
            // Get answer based on question type
            if (questionItem.find('input[type="radio"]:checked').length > 0) {
                answer = questionItem.find('input[type="radio"]:checked').val();
            } else if (questionItem.find('input[type="number"]').length > 0) {
                answer = questionItem.find('input[type="number"]').val();
            } else if (questionItem.find('textarea').length > 0) {
                answer = questionItem.find('textarea').val();
            }
            
            if (isRequired && !answer.trim()) {
                isValid = false;
                questionItem.addClass('border-danger');
                if (!firstInvalid) {
                    firstInvalid = questionItem;
                }
            } else {
                questionItem.removeClass('border-danger');
            }
        });
        
        if (!isValid) {
            e.preventDefault();
            alert('Please answer all required questions.');
            if (firstInvalid) {
                $('html, body').animate({
                    scrollTop: firstInvalid.offset().top - 100
                }, 500);
            }
        }
    });

    // Auto-save functionality (optional)
    var autoSaveTimer;
    $('input, textarea').on('change', function() {
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(function() {
            // In a real implementation, this would save to localStorage or server
            console.log('Auto-saving progress...');
        }, 2000);
    });

    // Progress indicator
    function updateProgress() {
        var totalQuestions = $('.question-test-item').length;
        var answeredQuestions = 0;
        
        $('.question-test-item').each(function() {
            var questionItem = $(this);
            var hasAnswer = false;
            
            if (questionItem.find('input[type="radio"]:checked').length > 0 ||
                questionItem.find('input[type="number"]').val().trim() ||
                questionItem.find('textarea').val().trim()) {
                hasAnswer = true;
            }
            
            if (hasAnswer) {
                answeredQuestions++;
                questionItem.addClass('answered');
            } else {
                questionItem.removeClass('answered');
            }
        });
        
        var progress = (answeredQuestions / totalQuestions) * 100;
        
        if (!$('.progress-container').length) {
            $('.card-header').append('<div class="progress-container mt-3"><div class="progress"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"></div></div><small class="text-muted">Progress: <span class="progress-text">0%</span></small></div>');
        }
        
        $('.progress-bar').css('width', progress + '%').attr('aria-valuenow', progress);
        $('.progress-text').text(Math.round(progress) + '% (' + answeredQuestions + '/' + totalQuestions + ')');
    }

    // Update progress on any input change
    $('input, textarea').on('change', updateProgress);
    
    // Initial progress update
    updateProgress();
});
</script>
}
