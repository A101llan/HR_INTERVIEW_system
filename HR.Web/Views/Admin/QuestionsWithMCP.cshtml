@model List<HR.Web.Models.QuestionAdminViewModel>
@{
    ViewBag.Title = "Manage Questions (MCP Enhanced)";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Questions</h2>
        <div>
            <button class="btn btn-outline-primary" onclick="$('#addQuestionChoiceModal').modal('show');">
                Add Question
            </button>
        </div>
    </div>
    
    <!-- MCP Status -->
    <div id="mcpStatus" class="alert alert-info">
        <strong>Checking MCP Connection...</strong>
    </div>

    <!-- Quick Actions -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>Quick Actions</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-12">
                    <button id="exportQuestions" class="btn btn-outline-secondary btn-block">
                        Export Question Bank
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    @if (TempData["Message"] != null) {
        <div class="alert alert-success">@TempData["Message"]</div>
    }
    
    <!-- Filters and Search -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <input type="text" id="searchQuestions" class="form-control" placeholder="Search questions...">
                </div>
                <div class="col-md-3">
                    <select id="filterType" class="form-control">
                        <option value="">All Types</option>
                        <option value="Text">Text</option>
                        <option value="Choice">Choice</option>
                        <option value="Number">Number</option>
                        <option value="Rating">Rating</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select id="filterStatus" class="form-control">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button id="clearFilters" class="btn btn-outline-secondary btn-block">Clear</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Questions Table -->
    <div class="card">
        <div class="card-header">
            <h5>Sample Questions (@Model.Count)</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-striped" id="questionsTable">
                    <thead>
                        <tr>
                            <th>Question</th>
                            <th>Type</th>
                            <th>Options</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var q in Model) {
                            <tr data-question-id="@q.Id" data-question-text="@q.Text" data-question-type="@q.Type">
                                <td>
                                    <strong>@q.Text</strong>
                                    <br/>
                                    <small class="text-muted">ID: @q.Id</small>
                                </td>
                                <td>
                                    <span class="badge badge-info">@q.Type</span>
                                </td>
                                <td>
                                    <div class="options-preview">
                                        @if (q.Options.Any()) {
                                            <ul class="list-unstyled mb-0">
                                                @foreach (var o in q.Options.Take(2)) {
                                                    <li>
                                                        <small>@o.Text</small>
                                                        <span class="badge badge-light ml-1">@o.Points pts</span>
                                                    </li>
                                                }
                                                @if (q.Options.Count > 2) {
                                                    <li><small class="text-muted">+@(q.Options.Count - 2) more...</small></li>
                                                }
                                            </ul>
                                        } else {
                                            <em class="text-muted">No options</em>
                                        }
                                    </div>
                                </td>
                                <td>
                                    <span class="badge badge-@(q.IsActive ? "success" : "secondary")">
                                        @(q.IsActive ? "Active" : "Inactive")
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a class="btn btn-sm btn-outline-primary" href="@Url.Action("EditQuestion", "Admin", new { id = q.Id })" title="Edit">
                                            Edit
                                        </a>
                                        <form method="post" action="@Url.Action("DeleteQuestion", "Admin")" style="display:inline;" onsubmit="return confirm('Delete this question and all its options?');">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="id" value="@q.Id" />
                                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete">                                            Delete</button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Question Choice Modal -->
<div class="modal fade" id="addQuestionChoiceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">How would you like to add a question?</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-edit"></i> Classic
                                </h6>
                                <p class="card-text text-muted">Write the question and choices yourself</p>
                                <button type="button" class="btn btn-outline-primary btn-block" onclick="window.location.href='@Url.Action("EditQuestion", "Admin")';">
                                    Choose Classic
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100 border-primary">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-magic"></i> AI Generate
                                </h6>
                                <p class="card-text text-muted">Generate questions using AI based on a job description</p>
                                <button type="button" class="btn btn-primary btn-block" onclick="showAIGenerationForm();">
                                    Choose AI Generate
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- AI Generation Form (hidden by default) -->
                <div id="aiGenerationForm" style="display:none; margin-top:20px;">
                    <hr>
                    <h6>Generate Questions with AI</h6>
                    <div class="form-group">
                        <label>Desired Position Title <span class="text-danger">*</span></label>
                        <input type="text" id="batchJobTitle" class="form-control" placeholder="e.g., Senior Backend Engineer" />
                        <small class="form-text text-muted">This title is used to tailor the generated questions.</small>
                    </div>
                    <div class="form-group">
                        <label>Job Description <span class="text-danger">*</span></label>
                        <textarea id="batchJobDescription" class="form-control" rows="4" placeholder="Paste job description here..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Number of Questions</label>
                        <input type="number" id="batchCount" class="form-control" value="10" min="1" max="20" />
                    </div>
                    <div class="form-group">
                        <label>Question Types</label>
                        <div class="checkbox">
                            <label><input type="checkbox" value="technical" checked> Technical</label>
                        </div>
                        <div class="checkbox">
                            <label><input type="checkbox" value="behavioral" checked> Behavioral</label>
                        </div>
                        <div class="checkbox">
                            <label><input type="checkbox" value="situational"> Situational</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="form-check">
                            <input type="checkbox" id="createNewPosition" class="form-check-input" />
                            <label class="form-check-label" for="createNewPosition">
                                Create as a new job position
                            </label>
                        </div>
                    </div>
                    <div id="newPositionFields" style="display:none;" class="border-top pt-3">
                        <h6>New Position Details</h6>
                        <div class="form-group">
                            <label>Position Title</label>
                            <input type="text" id="newPositionTitle" class="form-control" placeholder="e.g., Senior Backend Engineer" />
                        </div>
                        <div class="form-group">
                            <label>Position Description</label>
                            <textarea id="newPositionDescription" class="form-control" rows="3" placeholder="Brief description for the position listing"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Department</label>
                            <select id="newPositionDepartment" class="form-control">
                                <option value="">-- Select Department --</option>
                            </select>
                        </div>
                    </div>
                    <small class="form-text text-muted">Position title and description are used to tailor generated questions.</small>
                    
                    <!-- Results Panel for Generated Questions -->
                    <div id="batchGenerationResults" style="display:none; margin-top:20px;">
                        <h6>Generated Questions</h6>
                        <div id="batchQuestionsList"></div>
                        <div class="mt-3" id="generatedQuestionsActions" style="display:none;">
                            <!-- Add to Sample Questions -->
                            <div class="mb-2" id="addToSampleSection">
                                <button type="button" class="btn btn-primary" onclick="addGeneratedQuestionsToSample()"
                                    data-bs-toggle="tooltip" data-bs-placement="top" 
                                    title="Add these questions to the sample questions collection">
                                    <i class="fas fa-bookmark"></i> Add to Sample Questions
                                </button>
                            </div>
                            
                            <!-- Always show Add to Question Bank -->
                            <div class="mb-2" id="addToBankSection">
                                <button type="button" class="btn btn-success" onclick="addGeneratedQuestionsToBank()"
                                    data-bs-toggle="tooltip" data-bs-placement="top" 
                                    title="Questions become available for all positions">
                                    <i class="fas fa-plus"></i> Add to Question Bank
                                </button>
                            </div>
                            
                            <!-- Only show Create Position when checkbox is checked -->
                            <div id="createPositionSection" style="display:none;">
                                <button type="button" class="btn btn-primary" onclick="createPositionAndAddQuestions()">
                                    <i class="fas fa-briefcase"></i> Create Position & Add Questions
                                </button>
                                <small class="form-text text-muted d-block mt-1">
                                    Create a new position with these questions assigned
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="executeBatchGenerate" style="display:none;">Generate Questions</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<style>
.options-preview ul {
    max-height: 60px;
    overflow-y: auto;
}

.btn-group .btn {
    padding: 0.25rem 0.5rem;
}

.question-row {
    transition: background-color 0.2s ease;
}

.question-row:hover {
    background-color: #f8f9fa;
}

.highlight {
    background-color: #fff3cd !important;
    transition: background-color 0.5s ease;
}
</style>

@section Scripts {
<script>
$(document).ready(function() {
    // Check MCP connection
    checkMCPConnection();

    // Pre-load departments for new position dropdown
    loadDepartments();

    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Search functionality
    $('#searchQuestions').on('input', filterQuestions);
    $('#filterType').change(filterQuestions);
    $('#filterStatus').change(filterQuestions);
    $('#clearFilters').click(clearFilters);

    // Export questions
    $('#exportQuestions').click(function() {
        exportQuestionBank();
    });

    // Toggle new position fields
    $('#createNewPosition').change(function() {
        if ($(this).is(':checked')) {
            $('#newPositionFields').show();
            // Auto-populate position title from job title
            $('#newPositionTitle').val($('#batchJobTitle').val());
            // Show create position section if questions are already generated
            if ($('#generatedQuestionsActions').is(':visible')) {
                $('#createPositionSection').show();
            }
        } else {
            $('#newPositionFields').hide();
            // Hide create position section
            $('#createPositionSection').hide();
        }
    });

    // Load departments for dropdown
    function loadDepartments() {
        $.ajax({
            url: '@Url.Action("GetDepartments", "Admin")',
            type: 'GET',
            success: function(response) {
                if (response.success) {
                    var select = $('#newPositionDepartment');
                    select.empty().append('<option value="">-- Select Department --</option>');
                    response.departments.forEach(function(dept) {
                        select.append('<option value="' + dept + '">' + dept + '</option>');
                    });
                }
            },
            error: function() {
                console.error('Failed to load departments');
            }
        });
    }

    // Auto-sync position title with job title when typing
    $('#batchJobTitle').on('input', function() {
        if ($('#createNewPosition').is(':checked')) {
            $('#newPositionTitle').val($(this).val());
        }
    });

    // Show AI generation form
    window.showAIGenerationForm = function() {
        $('.card').hide(); // Hide choice cards
        $('#aiGenerationForm').show();
        $('#executeBatchGenerate').show();
    };

    // Store generated questions globally for action functions
    var generatedQuestions = [];

    function addGeneratedQuestionsToBank() {
        if (!generatedQuestions.length) {
            alert('No questions to add. Please generate questions first.');
            return;
        }
        
        $.ajax({
            url: '@Url.Action("AddGeneratedQuestionsToBank", "Admin")',
            type: 'POST',
            data: {
                questionsJson: JSON.stringify(generatedQuestions)
            },
            success: function(response) {
                if (response.success) {
                    alert(response.message);
                    // Clear the generated questions
                    generatedQuestions = [];
                    $('#batchGenerationResults').hide();
                    $('#generatedQuestionsActions').hide();
                    $('#batchQuestionsList').empty();
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function() {
                alert('Error adding questions to bank');
            }
        });
    }

    function addGeneratedQuestionsToSample() {
        if (!generatedQuestions.length) {
            alert('No questions to add. Please generate questions first.');
            return;
        }

        // Convert generated questions to the format expected by the backend
        var questionsToAdd = generatedQuestions.map(function(q, index) {
            return {
                id: index, // Use index as temporary ID
                text: q.text || q.question || '',
                type: q.type || 'Text',
                isActive: true
            };
        });

        // Call backend to check for duplicates
        $.ajax({
            url: '@Url.Action("AddToSampleQuestions", "Admin")',
            type: 'POST',
            data: {
                questionsJson: JSON.stringify(questionsToAdd)
            },
            success: function(response) {
                if (response.success) {
                    if (response.requiresDecision) {
                        // Show duplicate decision modal
                        showDuplicateDecisionModal(response.duplicates, response.newQuestions);
                    } else {
                        // No duplicates, show success
                        alert(response.message);
                        // Clear the generated questions
                        generatedQuestions = [];
                        $('#batchGenerationResults').hide();
                        $('#generatedQuestionsActions').hide();
                        $('#batchQuestionsList').empty();
                        setTimeout(() => location.reload(), 1000);
                    }
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function() {
                alert('Error adding questions to sample collection');
            }
        });
    }

    function createPositionAndAddQuestions() {
        var positionTitle = $('#newPositionTitle').val();
        var positionDescription = $('#newPositionDescription').val();
        var positionDepartment = $('#newPositionDepartment').val();
        
        if (!positionTitle || !positionDescription) {
            alert('Please fill in the new position details.');
            return;
        }
        
        if (!generatedQuestions.length) {
            alert('No questions to add. Please generate questions first.');
            return;
        }
        
        // TODO: Implement server endpoint to create position and assign questions
        alert('Feature coming soon: New position will be created and questions assigned.');
    }

    // Batch operations
    $('#executeBatchGenerate').click(executeBatchGeneration);

    // Functions
    function checkMCPConnection() {
        $.ajax({
            url: '@Url.Action("TestMCPConnection", "Admin")',
            type: 'GET',
            success: function(response) {
                if (response.success && response.connected) {
                    $('#mcpStatus').removeClass('alert-warning').addClass('alert-success')
                        .html('<strong>MCP Connected:</strong> AI features available');
                } else {
                    $('#mcpStatus').removeClass('alert-info').addClass('alert-warning')
                        .html('<strong>MCP Not Available:</strong> Some AI features may be limited');
                }
            },
            error: function() {
                $('#mcpStatus').removeClass('alert-info').addClass('alert-danger')
                    .html('<strong>MCP Error:</strong> Unable to connect to MCP server');
            }
        });
    }

    function filterQuestions() {
        var searchTerm = $('#searchQuestions').val().toLowerCase();
        var typeFilter = $('#filterType').val();
        var statusFilter = $('#filterStatus').val();

        $('#questionsTable tbody tr').each(function() {
            var row = $(this);
            var questionText = row.find('td:first').text().toLowerCase();
            var questionType = row.data('question-type');
            var isActive = row.find('.badge-success').length > 0;

            var matchesSearch = questionText.includes(searchTerm);
            var matchesType = !typeFilter || questionType === typeFilter;
            var matchesStatus = !statusFilter || 
                (statusFilter === 'active' && isActive) || 
                (statusFilter === 'inactive' && !isActive);

            row.toggle(matchesSearch && matchesType && matchesStatus);
        });
    }

    function clearFilters() {
        $('#searchQuestions').val('');
        $('#filterType').val('');
        $('#filterStatus').val('');
        filterQuestions();
    }

    function executeBatchGeneration() {
        var jobTitle = $('#batchJobTitle').val();
        var jobDescription = $('#batchJobDescription').val();
        var count = parseInt($('#batchCount').val()) || 10;
        var questionTypes = [];

        $('input[type="checkbox"]:checked').each(function() {
            questionTypes.push($(this).val());
        });

        // Validate required fields
        if (!jobTitle) {
            alert('Please enter a desired position title.');
            return;
        }
        if (!jobDescription) {
            alert('Please provide a job description.');
            return;
        }

        console.log('Sending parameters:', {
            jobTitle: jobTitle,
            jobDescription: jobDescription,
            experience: 'mid',
            questionTypes: questionTypes,
            count: count
        });

        $.ajax({
            url: '@Url.Action("GenerateQuestions", "Admin")',
            type: 'POST',
            traditional: true,
            data: {
                jobTitle: jobTitle,
                jobDescription: jobDescription,
                experience: 'mid',
                questionTypes: questionTypes,
                count: count
            },
            success: function(response) {
                console.log('Received response:', response);
                console.log('Number of questions:', response.questions ? response.questions.length : 0);
                
                if (response.success && response.questions && response.questions.length > 0) {
                    // Store generated questions globally
                    generatedQuestions = response.questions;
                    
                    // Render questions in the results panel with action buttons
                    var html = '<ol>';
                    response.questions.forEach(function(q, i) {
                        html += '<li style="margin-bottom:10px;"><strong>' + (q.text || q.question || '') + '</strong>';
                        if (q.options && q.options.length > 0) {
                            html += '<ul>';
                            q.options.forEach(function(opt) {
                                html += '<li>' + (opt.text || opt) + '</li>';
                            });
                            html += '</ul>';
                        }
                        html += '</li>';
                    });
                    html += '</ol>';
                    
                    $('#batchQuestionsList').html(html);
                    $('#batchGenerationResults').show();
                    $('#generatedQuestionsActions').show();
                    
                    // Show/hide create position section based on checkbox
                    var createNewPos = $('#createNewPosition').is(':checked');
                    if (createNewPos) {
                        $('#createPositionSection').show();
                    } else {
                        $('#createPositionSection').hide();
                    }
                } else {
                    $('#batchQuestionsList').html('<div class="alert alert-warning">No questions generated. Try again or check your input.</div>');
                    $('#batchGenerationResults').show();
                    $('#generatedQuestionsActions').hide();
                }
            },
            error: function() {
                alert('Error generating questions');
            }
        });
    }

    function exportQuestionBank() {
        var questions = [];
        $('#questionsTable tbody tr').each(function() {
            var row = $(this);
            questions.push({
                id: row.data('question-id'),
                text: row.data('question-text'),
                type: row.data('question-type')
            });
        });

        var dataStr = JSON.stringify(questions, null, 2);
        var dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        
        var exportFileDefaultName = 'question-bank-' + new Date().toISOString().slice(0,10) + '.json';
        
        var linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
    }

    function addToSampleQuestions() {
        var selectedQuestions = [];
        var hasSelection = false;

        // Check if any questions are selected (we'll need to add checkboxes first)
        $('#questionsTable tbody tr').each(function() {
            var row = $(this);
            var checkbox = row.find('input[type="checkbox"]:checked');
            
            if (checkbox.length > 0) {
                hasSelection = true;
                selectedQuestions.push({
                    id: row.data('question-id'),
                    text: row.data('question-text'),
                    type: row.data('question-type'),
                    isActive: row.find('.badge-success').length > 0
                });
            }
        });

        if (!hasSelection) {
            // If no checkboxes exist, add all visible questions
            $('#questionsTable tbody tr:visible').each(function() {
                var row = $(this);
                selectedQuestions.push({
                    id: row.data('question-id'),
                    text: row.data('question-text'),
                    type: row.data('question-type'),
                    isActive: row.find('.badge-success').length > 0
                });
            });
        }

        if (selectedQuestions.length === 0) {
            alert('No questions available to add to sample questions.');
            return;
        }

        // Call backend to check for duplicates
        $.ajax({
            url: '@Url.Action("AddToSampleQuestions", "Admin")',
            type: 'POST',
            data: {
                questionsJson: JSON.stringify(selectedQuestions)
            },
            success: function(response) {
                if (response.success) {
                    if (response.requiresDecision) {
                        // Show duplicate decision modal
                        showDuplicateDecisionModal(response.duplicates, response.newQuestions);
                    } else {
                        // No duplicates, show success
                        alert(response.message);
                        setTimeout(() => location.reload(), 1000);
                    }
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function() {
                alert('Error adding questions to sample collection');
            }
        });
    }

    function showDuplicateDecisionModal(duplicates, newQuestions) {
        var modalHtml = `
            <div class="modal fade" id="duplicateDecisionModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Duplicate Questions Review</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p><strong>Found ${duplicates.length} duplicate questions. Please decide which ones to keep:</strong></p>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>New Questions (${newQuestions.length})</h6>
                                    <div class="list-group" style="max-height: 300px; overflow-y: auto;">
                                        ${newQuestions.map(q => `
                                            <div class="list-group-item">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="new_${q.questionData.id}" checked>
                                                    <label class="form-check-label" for="new_${q.questionData.id}">
                                                        <strong>[${q.questionData.type}]</strong> ${q.questionData.text.substring(0, 100)}${q.questionData.text.length > 100 ? '...' : ''}
                                                    </label>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>Duplicate Questions (${duplicates.length})</h6>
                                    <div class="list-group" style="max-height: 300px; overflow-y: auto;">
                                        ${duplicates.map(d => `
                                            <div class="list-group-item">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="dup_${d.id}" data-duplicate='${JSON.stringify(d)}'>
                                                        <label class="form-check-label" for="dup_${d.id}">
                                                            <strong>[${d.type}]</strong> ${d.text.substring(0, 100)}${d.text.length > 100 ? '...' : ''}
                                                            <br><small class="text-muted">Existing: ${d.existingQuestionText.substring(0, 80)}${d.existingQuestionText.length > 80 ? '...' : ''}</small>
                                                        </label>
                                                    </div>
                                                    <div class="btn-group btn-group-sm">
                                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectDuplicateAction('${d.id}', 'keep')">Keep</button>
                                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectDuplicateAction('${d.id}', 'skip')">Skip</button>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="processDuplicateDecisions(${newQuestions.length}, ${duplicates.length})">
                                Process Decisions
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove existing modal if any
        $('#duplicateDecisionModal').remove();
        
        // Add new modal to body
        $('body').append(modalHtml);
        
        // Show modal
        var modal = new bootstrap.Modal(document.getElementById('duplicateDecisionModal'));
        modal.show();

        // Clean up on modal hide
        $('#duplicateDecisionModal').on('hidden.bs.modal', function () {
            $(this).remove();
        });
    }

    function selectDuplicateAction(duplicateId, action) {
        var checkbox = $(`#dup_${duplicateId}`);
        checkbox.data('action', action);
        
        // Update button styles
        var parent = checkbox.closest('.list-group-item');
        parent.find('.btn-outline-primary').toggleClass('btn-outline-primary btn-primary', action === 'keep');
        parent.find('.btn-outline-secondary').toggleClass('btn-outline-secondary btn-secondary', action === 'skip');
    }

    function processDuplicateDecisions(newCount, duplicateCount) {
        var decisions = [];
        
        // Add all new questions (they're checked by default)
        for (let i = 0; i < newCount; i++) {
            // These will be processed automatically
        }
        
        // Process duplicate decisions
        $('#duplicateDecisionModal input[data-duplicate]').each(function() {
            var $this = $(this);
            var duplicateData = JSON.parse($this.data('duplicate'));
            var action = $this.data('action') || ($this.is(':checked') ? 'keep' : 'skip');
            
            decisions.push({
                id: duplicateData.id,
                newText: duplicateData.text,
                type: duplicateData.type,
                action: action,
                existingQuestionId: duplicateData.existingQuestionId
            });
        });

        if (decisions.length === 0) {
            alert('Please make decisions for duplicate questions.');
            return;
        }

        // Send decisions to backend
        $.ajax({
            url: '@Url.Action("ProcessDuplicateDecisions", "Admin")',
            type: 'POST',
            data: {
                decisionsJson: JSON.stringify(decisions)
            },
            success: function(response) {
                if (response.success) {
                    $('#duplicateDecisionModal').modal('hide');
                    alert(response.message);
                    // Clear the generated questions
                    generatedQuestions = [];
                    $('#batchGenerationResults').hide();
                    $('#generatedQuestionsActions').hide();
                    $('#batchQuestionsList').empty();
                    setTimeout(() => location.reload(), 1000);
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function() {
                alert('Error processing duplicate decisions');
            }
        });
    }
});
</script>
}
