@model HR.Web.Models.QuestionAdminViewModel
@{
    ViewBag.Title = Model.Id.HasValue ? "Edit Question (MCP Enhanced)" : "Add Question (MCP Enhanced)";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-4">
    <h2>@ViewBag.Title</h2>
    
    @if (ViewBag.MCPConnected == true)
    {
        <div class="alert alert-info">
            <strong>MCP Connected:</strong> AI-powered question generation and validation available
        </div>
    }
    else
    {
        <div class="alert alert-warning">
            <strong>MCP Not Available:</strong> Some AI features may be limited
        </div>
    }

    

    @using (Html.BeginForm("EditQuestion", "Admin", FormMethod.Post, null))
    {
        @Html.AntiForgeryToken()
        @Html.HiddenFor(m => m.Id)
        
        <div class="card">
            <div class="card-header">
                <h5>Question Details</h5>
            </div>
            <div class="card-body">
                <div class="form-group mb-3">
                    @Html.LabelFor(m => m.Text, new { @class = "font-weight-bold" })
                    @Html.TextBoxFor(m => m.Text, new { @class = "form-control", id = "questionText" })
                    @Html.ValidationMessageFor(m => m.Text)
                    <button type="button" id="validateQuestion" class="btn btn-sm btn-info mt-1">Validate Question</button>
                </div>

                <div class="form-group mb-3">
                    @Html.LabelFor(m => m.Type, new { @class = "font-weight-bold" })
                    @{
                        var typeOptions = HR.Web.Models.QuestionAdminViewModel.AllowedTypes;
                    }
                    @Html.DropDownListFor(
                        m => m.Type,
                        new SelectList(typeOptions, Model.Type),
                        "-- Select question type --",
                        new { @class = "form-control", id = "questionType" })
                </div>

                <div class="form-check mb-3">
                    @Html.CheckBoxFor(m => m.IsActive, new { @class = "form-check-input" })
                    @Html.LabelFor(m => m.IsActive, new { @class = "form-check-label" })
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Options/Choices</h5>
                <button type="button" id="suggestPoints" class="btn btn-sm btn-warning">ðŸ’¡ Suggest Points</button>
            </div>
            <div class="card-body">
                <table class="table table-bordered" id="optionsTable">
                    <thead>
                        <tr>
                            <th>Text</th>
                            <th>Points</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (int i = 0; i < Model.Options.Count; i++)
                        {
                            <tr>
                                <td>@Html.TextBoxFor(m => m.Options[i].Text, new { @class = "form-control option-text" })</td>
                                <td>@Html.TextBoxFor(m => m.Options[i].Points, new { @class = "form-control option-points", type = "number", step = "0.01" })</td>
                                <td><button type="button" class="btn btn-danger btn-sm" onclick="removeOption(this)">Remove</button></td>
                                @Html.HiddenFor(m => m.Options[i].Id)
                            </tr>
                        }
                    </tbody>
                </table>
                <button id="addOptionBtn" type="button" class="btn btn-secondary mb-3">Add Option</button>
            </div>
        </div>

        <div class="mt-4">
            <button type="submit" class="btn btn-success">Save Question</button>
            <a href="@Url.Action("Questions", "Admin")" class="btn btn-link">Cancel</a>
        </div>
    }

    <!-- Validation Results Modal -->
    <div class="modal fade" id="validationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Question Validation Results</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body" id="validationResults">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

<script>
$(function () {
    // Validation
    $('#validateQuestion').click(function() {
        var questionText = $('#questionText').val();
        var questionType = $('#questionType').val();

        $.ajax({
            url: '@Url.Action("ValidateQuestion", "Admin")',
            type: 'POST',
            data: {
                question: questionText,
                questionType: questionType
            },
            success: function(response) {
                if (response.success) {
                    var html = '<div class="alert ' + (response.validation.isValid ? 'alert-success' : 'alert-warning') + '">';
                    html += '<h6>Validation Status: ' + (response.validation.isValid ? 'Valid' : 'Issues Found') + '</h6>';
                    html += '<p>Clarity Score: ' + response.validation.clarityScore + '/10</p>';
                    
                    if (response.validation.warnings.length > 0) {
                        html += '<h6>Warnings:</h6><ul>';
                        response.validation.warnings.forEach(function(warning) {
                            html += '<li>' + warning + '</li>';
                        });
                        html += '</ul>';
                    }
                    
                    if (response.validation.suggestions.length > 0) {
                        html += '<h6>Suggestions:</h6><ul>';
                        response.validation.suggestions.forEach(function(suggestion) {
                            html += '<li>' + suggestion + '</li>';
                        });
                        html += '</ul>';
                    }
                    
                    html += '</div>';
                    
                    $('#validationResults').html(html);
                    $('#validationModal').modal('show');
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function() {
                alert('Error validating question');
            }
        });
    });

    // Suggest Points
    $('#suggestPoints').click(function() {
        var questionText = $('#questionText').val();
        var options = [];
        
        $('.option-text').each(function() {
            var text = $(this).val();
            if (text) {
                options.push(text);
            }
        });

        if (options.length === 0) {
            alert('This question has no options to optimize');
            return;
        }

        $.ajax({
            url: '@Url.Action("SuggestPoints", "Admin")',
            type: 'POST',
            data: {
                question: questionText,
                options: options,
                difficulty: 'intermediate'
            },
            success: function(response) {
                if (response.success) {
                    alert('Point suggestions calculated. Please review and apply them manually.');
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function() {
                alert('Error optimizing points');
            }
        });
    });

    // Add/Remove Options
    window.addOption = function() {
        var index = $('#optionsTable tbody tr').length;
        var row = '<tr>' +
            '<td><input type="text" name="Options[' + index + '].Text" class="form-control option-text" /></td>' +
            '<td><input type="number" name="Options[' + index + '].Points" class="form-control option-points" step="0.01" /></td>' +
            '<td><button type="button" class="btn btn-danger btn-sm" onclick="removeOption(this)">Remove</button></td>' +
            '</tr>';
        $('#optionsTable tbody').append(row);
    };

    window.removeOption = function(btn) {
        $(btn).closest('tr').remove();
    };

    $('#addOptionBtn').click(addOption);
});
</script>
